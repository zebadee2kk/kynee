name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install ruff black mypy
      - name: Run ruff
        run: ruff check agent/ console/backend/
      - name: Run black
        run: black --check agent/ console/backend/
      - name: Run mypy
        run: mypy agent/ console/backend/ || true  # Allow failures initially

  test-agent:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install agent dependencies
        run: |
          cd agent
          pip install -e ".[dev]" || echo "pyproject.toml not yet available"
      - name: Run tests
        run: |
          cd agent
          pytest tests/ -v || echo "No tests yet"

  test-console-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install backend dependencies
        run: |
          cd console/backend
          pip install -e ".[dev]" || echo "pyproject.toml not yet available"
      - name: Run tests
        run: |
          cd console/backend
          pytest tests/ -v || echo "No tests yet"

  lint-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install frontend dependencies
        run: |
          cd console/frontend
          npm install || echo "package.json not yet available"
      - name: Run ESLint
        run: |
          cd console/frontend
          npm run lint || echo "No lint script yet"

  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install frontend dependencies
        run: |
          cd console/frontend
          npm install || echo "package.json not yet available"
      - name: Run tests
        run: |
          cd console/frontend
          npm test || echo "No tests yet"

  validate-schemas:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install jsonschema
        run: pip install jsonschema
      - name: Validate schemas
        run: |
          python -c "import json; from jsonschema import Draft202012Validator; \
          for schema_file in ['schemas/findings.schema.json', 'schemas/inventory.schema.json', \
          'schemas/auditlog.schema.json', 'schemas/agent-status.schema.json']: \
              with open(schema_file) as f: \
                  schema = json.load(f); \
                  Draft202012Validator.check_schema(schema); \
                  print(f'{schema_file} is valid')"
