{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://kynee.dev/schemas/auditlog.schema.json",
  "title": "KYNEÄ’ Audit Log Entry",
  "description": "Schema for immutable audit log entries tracking all agent actions",
  "type": "object",
  "properties": {
    "log_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for this log entry"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "When the action occurred (ISO 8601 UTC)"
    },
    "engagement_id": {
      "type": "string",
      "description": "Engagement this action is part of"
    },
    "agent_id": {
      "type": "string",
      "description": "Agent device UUID that performed the action"
    },
    "operator_id": {
      "type": "string",
      "description": "User/operator who authorized this action",
      "examples": ["alice@pentestco.com", "AI-Assistant-v1"]
    },
    "action": {
      "type": "string",
      "description": "Type of action performed",
      "enum": [
        "agent_startup",
        "agent_shutdown",
        "network_scan",
        "wireless_scan",
        "bluetooth_scan",
        "flipper_rfid_read",
        "flipper_nfc_read",
        "flipper_subghz_rx",
        "flipper_ir_rx",
        "flipper_badusb_run",
        "credential_test",
        "policy_violation_blocked",
        "engagement_start",
        "engagement_stop",
        "emergency_stop"
      ]
    },
    "target": {
      "type": "object",
      "properties": {
        "ip_range": {"type": "string"},
        "ip_address": {"type": "string"},
        "mac_address": {"type": "string"},
        "ssid": {"type": "string"},
        "hostname": {"type": "string"},
        "port": {"type": "integer"},
        "location": {"type": "string", "description": "Physical location if applicable"}
      }
    },
    "command": {
      "type": "string",
      "description": "Exact command executed (if applicable)",
      "examples": ["nmap -sS -p- 192.168.1.0/24", "airodump-ng wlan0mon"]
    },
    "tool": {
      "type": "string",
      "description": "Tool used for this action",
      "examples": ["nmap", "airodump-ng", "flipper-zero"]
    },
    "roe_reference": {
      "type": "string",
      "description": "Reference to Rules of Engagement section authorizing this action",
      "examples": ["Section 5.1: Network Scanning", "Section 6.3: Physical Access Testing"]
    },
    "justification": {
      "type": "string",
      "description": "Reason for this action (human-provided)"
    },
    "outcome": {
      "type": "string",
      "enum": ["success", "failure", "blocked_by_policy", "error"],
      "description": "Result of the action"
    },
    "findings_count": {
      "type": "integer",
      "minimum": 0,
      "description": "Number of findings generated by this action"
    },
    "error_message": {
      "type": "string",
      "description": "Error details if outcome was failure or error"
    },
    "duration_seconds": {
      "type": "number",
      "minimum": 0,
      "description": "How long the action took to complete"
    },
    "metadata": {
      "type": "object",
      "description": "Additional action-specific metadata",
      "additionalProperties": true
    },
    "previous_log_hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA-256 hash of previous log entry (for chain integrity)"
    },
    "log_hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA-256 hash of this log entry"
    }
  },
  "required": [
    "log_id",
    "timestamp",
    "engagement_id",
    "agent_id",
    "operator_id",
    "action",
    "outcome",
    "log_hash"
  ],
  "additionalProperties": false
}
